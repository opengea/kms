
DOCUMENTACIO TECNICA KMS
========================


Com instal.lar un servidor KMS
-------------------------------
1. Configurar apache, conf.d > yy_kms.conf 

 bàsicament conté:
     # activar extranet per tots els dominis.
		        ServerAlias extranet.*
     # a extranet definim directori root
            DocumentRoot /usr/local/kms/
     # alias directori share de kms:
		Alias /kms/ /usr/share/kms/
     # accés a  tots els vhosts, i al kernel del kms.
                        php_admin_value open_basedir ".:/var/www/vhosts:/usr/share/kms:/usr/local/kms:/tmp:/var/tmp"
                        php_admin_value include_path ".:/var/www/vhosts:/usr/share/kms:/usr/local/kms:/tmp:/var/tmp"

2. Configurar base de dades:
	/usr/local/kms/lib/dbi/openClientDB.php 
	crear base de dades intergrid
	crear taula kms_extranet_accounts


Instruccions per donar d'alta un client
---------------------------------------
   - crear subdomini data
   - anar a extranet.intergrid.cat i donar d'alta client
   - crear base de dades amb taules segons els tipus que es requereixin
   - copiar els mods requerits al directori data
   - donar permisos d'escriptura al directori files i tmp de data.
   - configurar acces a base de dades a conf/

Instruccions per activar sistema multiusuari a client
-----------------------------------------------------
   - marcar checkbox multiuser a extranets
   - assegurar que existeix taula kms_sys_users i kms_sessions

Configuracio de web amb KMS
---------------------------
si el client te la web amb intergrid posar un Alias al httpd.conf.include i redireccionar cap a /usr/local/kms


dominis
--------------------
extranet.dominiclient.com <- ja esta preconfigurat a apache
data.dominiclient.com  <- directori fisic, cal crear-lo

Estructura de directoris del KMS
--------------------------------

/usr/local/kms  : kernel del KMS (només accessible mitjançant includes de php)
/usr/share/kms  : llibreries compartides del KMS. El client accedeix mitjançant un alias d'apache /kms/
/var/www/vhosts/DOMINICLIENT/subdomains/data/httpdocs   : peronalitzacio extranet de client
/var/www/vhosts/DOMINICLIENT/httpdocs/  : web kms (opcional)


Estructura de /usr/local/kms
----------------------------

lang/ <- fitxers d'idioma
lib/ <- llibreries internes del KMS
tpl/ <- plantilles predefinides
docs/ <- documentacio KMS


Estructura de /usr/share/kms
-----------------------------

/tpl/   <- plantilles html/php, les pot definir en fitxer o en base de dades
/css/   <- estils i temes gràfics
/files/ <- fitxers imatges, pdfs,..
/lib/   <- funcions ajax i javascript, les crida el mateix client


----
dataBrowser esdevindra amb el temps un explorador de bases de dades "en cru", el filesystem del sistema.


harmonització entre estandarització i personalització
=====================================================
la màxima del KMS esta en aprofitar codi, tot allò que sigui reutilitzable encapsular-ho en una funció.

l'armonització que fa el kms consisteix en definir unes bases de dades amb uns noms preestablers
i uns camps minims fixes que mantenen la compatibilitat bàsica amb els serveis,
i tota una sèrie de camps d'usuari personalitzables i extensibles mitjançant funcions personalitzades de php.
una cosa interessant q podriem fer es definir una versió per cada taula de base de dades
de manera que l'aplicació en funció de la versió carregarà la llibreria adequada per gestionar-la.
d'aquesta manera no es trencaria mai una aplicació en cas que canvies l'estructura de la base de dades



ALGORITME
---------

/usr/local/kms/index.php
  * init_session
  *  /usr/local/kms/lib/globals.php
		* load variables
		* openClientDB.php -->
				* open intergrid DB
				* getClientData.php --> current domains..		
							fetch data
		* SI EXTRANET --->
				* check session --> if !logged --> login.php
				 /usr/local/kms/lib/kms_defaults.php
				kms.class.php

		  ELSE WEB ----> common_header

  * si EXTRANET
		/usr/local/kms/lib/kms_defaults.php
		   Si MOD >
                                /var/www/vhosts/$current_domain./subdomains/data/httpdocs/$_GET['mod'].php
                   ELSE
                         /usr/local/kms/lib/kms_index_defaults.php
                        /var/www/vhosts/$current_domain./subdomains/data/httpdocs/index.php

   ELSE WEB -->
	   	   SI MOD >
			/var/www/vhosts/$current_domain./subdomains/$current_dubdomain/httpdocs/$_GET['mod'].php
		   ELSE
			/usr/local/kms/lib/webs/starter.php      



NOMS DE CAMPS DE BASES DE DADES:
===========================

sr_  static reference field
dr_  dynamic reference field

crec que esta pensat perque nomes n'hi pugui haver un per taula.. investigar.i

CONSTANTS
==========
// definides a globals.php
define('KMS_VERSION', '1.0b');
define('KMS_CHARSET', 'UTF-8');
define('JS_OBJECT_NAME', 'kms');

$MAIN_TASKS = array('my account', 'settings', 'logout');
$KMS_PATH ="/usr/local/kms";


VARIABLES
==========
$current_domain 
i MOD >
                                /var/www/vhosts/$current_domain./subdomains/data/httpdocs/$_GET['mod'].php
                        ELSE
                         /usr/local/kms/lib/kms_index_defaults.php
                        /var/www/vhosts/$current_domain./subdomains/data/httpdocs/index.php

$_SESSION['user_logged'] = true;
$_SESSION['user_name']
$_SESSION['user_groups']
$_SESSION['user_realname']
$_SESSION['user_folderid']


CONNEXIO DB CLIENT
=============
$result = mysql_connect($client_account['dbhost'],$client_account['dbuser'],$client_account['dbpasswd']);
mysql_select_db ($client_account['dbname']);



CATALEG + ECOMMERCE
-----------------------------------
exemple: limpiafacil.com

* requereix conf/ al domini
* templates:   
         tpl/detailer.php
         tpl/gridnode.php


MANUAL
=========

/*=[ DATABASE ]==========================================================*/

$kms->dbname = "videoartworld";   /* OPTIONAL SI NO ES LA BBDD PER DEFECTE*/
$kms->dbuser = "videoart";           /* OPTIONAL */
$kms->dbpass = "B4RC3L0N4";     /* OPTIONAL */

$kms->table     = "curriculums";
$kms->key       = "id_line";    



$kms->default_content_type = "tickets";     <<--- imatge ico _big

/*=[ DATABROWSER ]=================================
$kms->fields = array("id",  "status", "opendate", "createdby", "priority", "objecttype", "sr_relatedto");

$kms->orderby = "status";
$kms->sortdir = "desc";
$kms->page_rows = 200;
$kms->page_links = 200;
$kms->insert_label = "Nou ticket";

// --- afegir vista----
vista = $kms->where." and status not like '%finalitzat%'"  per exemple


/*=[ DATAEDITOR]=================================

$kms->addRule("cipher","Password","MD5");
$kms->addRule("cipher","CardNum","MD5");
$kms->humanize("status","Estat");
$kms->defvalue("status","pendent");
$kms->ts_format  = "m/d/Y h:i A"

$kms->addRule("select","priority",array("baixa"=>"<font color=#666666>baixa</font>","normal"=>"<font color=#0000ff>normal</font>","alta"=>"<font color=#ff3300>alta</alta>","critica"=>"<font color=#ff0000><b>critica</b></font>"));

$kms->xcombo("sr_relatedto", "kms_contacts_entities", "id", "name", false, "");
$kms->xcombosql ("to_assamblea","select assamblea from kms_contacts where assamblea='Barcelona'");

$kms->addRule("uniselect","assignedto");

$kms->addRule("multiselect","assignedto");

// CHECKBOX
//$kms->addRule("checklist","Decoration",array("E"=>"Embroiderable","I"=>"Inscribeable"));

// uploads
$kms->addRule("file","attachment",array($kmspath."/data/tasks","data/tasks",false));

// my javascript functions include fdile
$_SESSION["myJsf"] = "tickets.js";

// no mostra el camp a la fitxa
//problema: si no el mostrem l'assigna si en creem un de nou!
//$kms->exclude = array("content_type");

//$kms->readonly = array("content_type");

//$kms->safedel("Display","N","Disable");

//$kms->xlist("partners","Business_Rid",array("Rid","Name","Description"));

//date_default_timezone_set('UTC');
$openDate = date('y-m-d');
$kms->defvalue("opendate",$openDate);

//$kms->validate("Email");
//$kms->validate("WWW");


/*=[ PERMISOS ]===========================================================*/

$kms->can_edit = true;
$kms->can_delete = true;
$kms->can_add   = true;
$kms->can_import = true;
$kms->can_export = true;
$kms->can_search = true;

/*==[ CROSS REFERENCES ]======================================

// per llistat
$kms->multixref("id_gallery", "id", "name", "t_gallery");
// per editor: combos relacionats  (camp local relacionat, taula relacionada, camp id relacionat, camp seleccio a mostrar, nomes lectura, linkcreate, linkedfield), 
$kms->xcombo("id_artist", "artists", "id_artist", "name", false, "");

/*==[ EVENTS ]===============================================
// event, integra un js (camp, tipus, condicio js, funcio js)
// s'ha de definir abans que el camp!

$kms->event("objecttype", "onChange", "1==1", "reloadRelatedto(this.value,'sr_relatedto')");

// fitxa amb botons browse. Te per parametre el select del SQL. Si no li passem res no dibuixa el navegador.
//$kms->addObjectNavigator();

/*=[ LEFT USER MENU CONFIGURATION : change it through conf/configuration.php file, or assign true or false ]====*/
$kms->showMenu = true;//$showMenu_default;

/*==[ BUTTONS ]================*/
//$kms->buttons['sendmailing']=true;

$kms->custombuttons = Array();
$kms->custombuttons[0] = Array ("url"=>"http://www.scalextric.es/services/mailing/","ico"=>"massmail.gif");


-------flv player jw-----------
http://home5.inet.tele.dk/nyboe/flash/mediaplayer/index.htm

88.36.215.145
---------- javascript example --------------

// javascript functions

function insertObjectNav (dbtable) {

valuetarget = document.forms["dm"][fieldname].value;
frames['loadState'].location.href="/usr/lib/insertObjectNav.php?sourcetable="+dbtable+"&valuetarget="+valuetarget;
// reload
setTimeout("document.location.reload()", 1500);

}


function reloadRelatedto(dbtable,fieldname) {
valuetarget = document.forms["dm"][fieldname].value;
frames['loadState'].location.href="/usr/lib/changeRuleDatasrc.php?formfield="+fieldname+"&sourcetable="+dbtable+"&valuetarget="+valuetarget;
// reload
setTimeout("document.location.reload()", 1500);

}


============ WEBSITES CMS =============
$website_data["xxx"]   <--- kms_websites
$current_menu["xx"]   <---- kms_menus



$_SERVER VARIABLES



